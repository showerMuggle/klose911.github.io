<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>ConfigMap</title>
<meta name="generator" content="Org mode" />
<meta name="author" content="Wu, Shanliang" />
<style type="text/css">
 <!--/*--><![CDATA[/*><!--*/
  .title  { text-align: center;
             margin-bottom: .2em; }
  .subtitle { text-align: center;
              font-size: medium;
              font-weight: bold;
              margin-top:0; }
  .todo   { font-family: monospace; color: red; }
  .done   { font-family: monospace; color: green; }
  .priority { font-family: monospace; color: orange; }
  .tag    { background-color: #eee; font-family: monospace;
            padding: 2px; font-size: 80%; font-weight: normal; }
  .timestamp { color: #bebebe; }
  .timestamp-kwd { color: #5f9ea0; }
  .org-right  { margin-left: auto; margin-right: 0px;  text-align: right; }
  .org-left   { margin-left: 0px;  margin-right: auto; text-align: left; }
  .org-center { margin-left: auto; margin-right: auto; text-align: center; }
  .underline { text-decoration: underline; }
  #postamble p, #preamble p { font-size: 90%; margin: .2em; }
  p.verse { margin-left: 3%; }
  pre {
    border: 1px solid #ccc;
    box-shadow: 3px 3px 3px #eee;
    padding: 8pt;
    font-family: monospace;
    overflow: auto;
    margin: 1.2em;
  }
  pre.src {
    position: relative;
    overflow: auto;
    padding-top: 1.2em;
  }
  pre.src:before {
    display: none;
    position: absolute;
    background-color: white;
    top: -10px;
    right: 10px;
    padding: 3px;
    border: 1px solid black;
  }
  pre.src:hover:before { display: inline; margin-top: 14px;}
  /* Languages per Org manual */
  pre.src-asymptote:before { content: 'Asymptote'; }
  pre.src-awk:before { content: 'Awk'; }
  pre.src-C:before { content: 'C'; }
  /* pre.src-C++ doesn't work in CSS */
  pre.src-clojure:before { content: 'Clojure'; }
  pre.src-css:before { content: 'CSS'; }
  pre.src-D:before { content: 'D'; }
  pre.src-ditaa:before { content: 'ditaa'; }
  pre.src-dot:before { content: 'Graphviz'; }
  pre.src-calc:before { content: 'Emacs Calc'; }
  pre.src-emacs-lisp:before { content: 'Emacs Lisp'; }
  pre.src-fortran:before { content: 'Fortran'; }
  pre.src-gnuplot:before { content: 'gnuplot'; }
  pre.src-haskell:before { content: 'Haskell'; }
  pre.src-hledger:before { content: 'hledger'; }
  pre.src-java:before { content: 'Java'; }
  pre.src-js:before { content: 'Javascript'; }
  pre.src-latex:before { content: 'LaTeX'; }
  pre.src-ledger:before { content: 'Ledger'; }
  pre.src-lisp:before { content: 'Lisp'; }
  pre.src-lilypond:before { content: 'Lilypond'; }
  pre.src-lua:before { content: 'Lua'; }
  pre.src-matlab:before { content: 'MATLAB'; }
  pre.src-mscgen:before { content: 'Mscgen'; }
  pre.src-ocaml:before { content: 'Objective Caml'; }
  pre.src-octave:before { content: 'Octave'; }
  pre.src-org:before { content: 'Org mode'; }
  pre.src-oz:before { content: 'OZ'; }
  pre.src-plantuml:before { content: 'Plantuml'; }
  pre.src-processing:before { content: 'Processing.js'; }
  pre.src-python:before { content: 'Python'; }
  pre.src-R:before { content: 'R'; }
  pre.src-ruby:before { content: 'Ruby'; }
  pre.src-sass:before { content: 'Sass'; }
  pre.src-scheme:before { content: 'Scheme'; }
  pre.src-screen:before { content: 'Gnu Screen'; }
  pre.src-sed:before { content: 'Sed'; }
  pre.src-sh:before { content: 'shell'; }
  pre.src-sql:before { content: 'SQL'; }
  pre.src-sqlite:before { content: 'SQLite'; }
  /* additional languages in org.el's org-babel-load-languages alist */
  pre.src-forth:before { content: 'Forth'; }
  pre.src-io:before { content: 'IO'; }
  pre.src-J:before { content: 'J'; }
  pre.src-makefile:before { content: 'Makefile'; }
  pre.src-maxima:before { content: 'Maxima'; }
  pre.src-perl:before { content: 'Perl'; }
  pre.src-picolisp:before { content: 'Pico Lisp'; }
  pre.src-scala:before { content: 'Scala'; }
  pre.src-shell:before { content: 'Shell Script'; }
  pre.src-ebnf2ps:before { content: 'ebfn2ps'; }
  /* additional language identifiers per "defun org-babel-execute"
       in ob-*.el */
  pre.src-cpp:before  { content: 'C++'; }
  pre.src-abc:before  { content: 'ABC'; }
  pre.src-coq:before  { content: 'Coq'; }
  pre.src-groovy:before  { content: 'Groovy'; }
  /* additional language identifiers from org-babel-shell-names in
     ob-shell.el: ob-shell is the only babel language using a lambda to put
     the execution function name together. */
  pre.src-bash:before  { content: 'bash'; }
  pre.src-csh:before  { content: 'csh'; }
  pre.src-ash:before  { content: 'ash'; }
  pre.src-dash:before  { content: 'dash'; }
  pre.src-ksh:before  { content: 'ksh'; }
  pre.src-mksh:before  { content: 'mksh'; }
  pre.src-posh:before  { content: 'posh'; }
  /* Additional Emacs modes also supported by the LaTeX listings package */
  pre.src-ada:before { content: 'Ada'; }
  pre.src-asm:before { content: 'Assembler'; }
  pre.src-caml:before { content: 'Caml'; }
  pre.src-delphi:before { content: 'Delphi'; }
  pre.src-html:before { content: 'HTML'; }
  pre.src-idl:before { content: 'IDL'; }
  pre.src-mercury:before { content: 'Mercury'; }
  pre.src-metapost:before { content: 'MetaPost'; }
  pre.src-modula-2:before { content: 'Modula-2'; }
  pre.src-pascal:before { content: 'Pascal'; }
  pre.src-ps:before { content: 'PostScript'; }
  pre.src-prolog:before { content: 'Prolog'; }
  pre.src-simula:before { content: 'Simula'; }
  pre.src-tcl:before { content: 'tcl'; }
  pre.src-tex:before { content: 'TeX'; }
  pre.src-plain-tex:before { content: 'Plain TeX'; }
  pre.src-verilog:before { content: 'Verilog'; }
  pre.src-vhdl:before { content: 'VHDL'; }
  pre.src-xml:before { content: 'XML'; }
  pre.src-nxml:before { content: 'XML'; }
  /* add a generic configuration mode; LaTeX export needs an additional
     (add-to-list 'org-latex-listings-langs '(conf " ")) in .emacs */
  pre.src-conf:before { content: 'Configuration File'; }

  table { border-collapse:collapse; }
  caption.t-above { caption-side: top; }
  caption.t-bottom { caption-side: bottom; }
  td, th { vertical-align:top;  }
  th.org-right  { text-align: center;  }
  th.org-left   { text-align: center;   }
  th.org-center { text-align: center; }
  td.org-right  { text-align: right;  }
  td.org-left   { text-align: left;   }
  td.org-center { text-align: center; }
  dt { font-weight: bold; }
  .footpara { display: inline; }
  .footdef  { margin-bottom: 1em; }
  .figure { padding: 1em; }
  .figure p { text-align: center; }
  .equation-container {
    display: table;
    text-align: center;
    width: 100%;
  }
  .equation {
    vertical-align: middle;
  }
  .equation-label {
    display: table-cell;
    text-align: right;
    vertical-align: middle;
  }
  .inlinetask {
    padding: 10px;
    border: 2px solid gray;
    margin: 10px;
    background: #ffffcc;
  }
  #org-div-home-and-up
   { text-align: right; font-size: 70%; white-space: nowrap; }
  textarea { overflow-x: auto; }
  .linenr { font-size: smaller }
  .code-highlighted { background-color: #ffff00; }
  .org-info-js_info-navigation { border-style: none; }
  #org-info-js_console-label
    { font-size: 10px; font-weight: bold; white-space: nowrap; }
  .org-info-js_search-highlight
    { background-color: #ffff00; color: #000000; font-weight: bold; }
  .org-svg { width: 90%; }
  /*]]>*/-->
</style>
<link rel="stylesheet" type="text/css" href="../../css/main.css" />
<script type="text/javascript">
// @license magnet:?xt=urn:btih:e95b018ef3580986a04669f1b5879592219e2a7a&dn=public-domain.txt Public Domain
<!--/*--><![CDATA[/*><!--*/
     function CodeHighlightOn(elem, id)
     {
       var target = document.getElementById(id);
       if(null != target) {
         elem.classList.add("code-highlighted");
         target.classList.add("code-highlighted");
       }
     }
     function CodeHighlightOff(elem, id)
     {
       var target = document.getElementById(id);
       if(null != target) {
         elem.classList.remove("code-highlighted");
         target.classList.remove("code-highlighted");
       }
     }
    /*]]>*///-->
// @license-end
</script>
</head>
<body>
<div id="org-div-home-and-up">
 <a accesskey="h" href="secret.html"> UP </a>
 |
 <a accesskey="H" href="storage.html"> HOME </a>
</div><div id="content">
<h1 class="title">ConfigMap</h1>
<div id="table-of-contents">
<h2>Table of Contents</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="#org80e4788">概述</a></li>
<li><a href="#org61ecff3">创建</a>
<ul>
<li><a href="#orgf4007de">目录</a></li>
<li><a href="#org4f98d81">文件</a></li>
<li><a href="#org2e5fb83">字面值</a></li>
</ul>
</li>
<li><a href="#orga67013c">使用</a>
<ul>
<li><a href="#org6839e5f">替代环境变量</a></li>
<li><a href="#orga167bf1">设置命令行参数</a></li>
<li><a href="#org764cd8e">数据卷插件使用ConfigMap</a></li>
</ul>
</li>
<li><a href="#org2341fe7">热更新</a>
<ul>
<li><a href="#orge60447e">测试示例</a></li>
<li><a href="#org2d0fb10">代码</a></li>
<li><a href="#org1ca8e81">测试</a>
<ul>
<li><a href="#org5d67d4c">更新使用ConfigMap挂载的Env</a></li>
<li><a href="#org205b601">更新使用ConfigMap挂载的Volume</a></li>
</ul>
</li>
<li><a href="#org1d87099">ConfigMap 更新后滚动更新 Pod</a></li>
<li><a href="#orgbfb1c44">总结</a></li>
</ul>
</li>
</ul>
</div>
</div>
<pre class="example" id="org1471e4f">
其实ConfigMap功能在Kubernetes1.2版本的时候就有了

许多应用程序会从配置文件、命令行参数或环境变量中读取配置信息

这些配置信息需要与docker image解耦，总不能每修改一个配置就重做一个image吧？
</pre>

<p>
ConfigMap API提供了向 <span class="underline">容器</span> 中 <b>注入</b> <span class="underline">配置信息</span> 的机制，ConfigMap可以被用来保存 <span class="underline">单个属性</span> ，也可以用来保存整个 <span class="underline">配置文件</span> 或者 <span class="underline">JSON二进制大对象</span>  
</p>

<div id="outline-container-org80e4788" class="outline-2">
<h2 id="org80e4788">概述</h2>
<div class="outline-text-2" id="text-org80e4788">
<p>
<span class="underline">ConfigMap</span> API资源用来保存 <span class="underline">key-value pair</span> <b>配置数据</b> ，这个数据可以在 <span class="underline">pods</span> 里使用，或者被用来为像 <span class="underline">controller</span> 一样的系统组件存储配置数据
</p>

<pre class="example" id="org289aec2">
虽然ConfigMap跟Secrets类似，但是ConfigMap更方便的处理不含敏感信息的字符串

注意：ConfigMaps不是属性配置文件的替代品，ConfigMaps只是作为多个properties文件的引用

可以把它理解为Linux系统中的/etc目录，专门用来存储配置文件的目录
</pre>

<p>
比如使用ConfigMap配置来创建Kubernetes Volumes，ConfigMap中的每个 <span class="underline">data</span> 项都会成为一个 <b>新文件</b> ：
</p>
<pre class="example" id="orgc6f0466">
kind: ConfigMap
apiVersion: v1
metadata:
  creationTimestamp: 2016-02-18T19:14:38Z
  name: example-config
  namespace: default
data:
  example.property.1: hello
  example.property.2: world
  example.property.file: |-
    property.1=value-1
    property.2=value-2
    property.3=value-3
</pre>

<p>
data一栏包括了配置数据，ConfigMap可以被用来保存单个属性，也可以用来保存一个配置文件。 配置数据可以通过很多种方式在Pods里被使用。ConfigMaps可以被用来：
</p>
<ul class="org-ul">
<li>设置 <span class="underline">环境变量</span> 的值</li>
<li>在容器里设置 <span class="underline">命令行参数</span></li>
<li>在数据卷里面创建 <span class="underline">config文件</span></li>
</ul>

<pre class="example" id="org17bbf51">
用户和系统组件两者都可以在ConfigMap里面存储配置数据
</pre>

<p>
从kubectl create configmap -h的帮助信息中就可以对ConfigMap究竟如何创建略知一二了：
</p>

<div class="org-src-container">
<pre class="src src-sh">Examples:
<span style="color: #ff4500;"># </span><span style="color: #ff4500;">Create a new configmap named my-config based on folder bar</span>
kubectl create configmap my-config --from-file=path/to/bar

<span style="color: #ff4500;"># </span><span style="color: #ff4500;">Create a new configmap named my-config with specified keys instead of file basenames on disk</span>
kubectl create configmap my-config --from-file=<span style="color: #eedd82;">key1</span>=/path/to/bar/file1.txt --from-file=<span style="color: #eedd82;">key2</span>=/path/to/bar/file2.txt

<span style="color: #ff4500;"># </span><span style="color: #ff4500;">Create a new configmap named my-config with key1=config1 and key2=config2</span>
kubectl create configmap my-config --from-literal=<span style="color: #eedd82;">key1</span>=config1 --from-literal=<span style="color: #eedd82;">key2</span>=config2
</pre>
</div>
</div>
</div>

<div id="outline-container-org61ecff3" class="outline-2">
<h2 id="org61ecff3">创建</h2>
<div class="outline-text-2" id="text-org61ecff3">
<p>
可以使用该命令，用给定值、文件或目录来创建ConfigMap：
</p>
<pre class="example" id="orgdfcee52">
kubectl create configmap
</pre>
</div>

<div id="outline-container-orgf4007de" class="outline-3">
<h3 id="orgf4007de">目录</h3>
<div class="outline-text-3" id="text-orgf4007de">
<p>
比如已经有了一些配置文件，其中包含了想要设置的ConfigMap的值：
</p>

<div class="org-src-container">
<pre class="src src-sh">$ ls docs/user-guide/configmap/kubectl/
game.properties
ui.properties

$ cat docs/user-guide/configmap/kubectl/game.properties
<span style="color: #eedd82;">enemies</span>=aliens
<span style="color: #eedd82;">lives</span>=3
enemies.cheat=true
enemies.cheat.level=noGoodRotten
secret.code.passphrase=UUDDLRLRBABAS
secret.code.allowed=true
secret.code.lives=30

$ cat docs/user-guide/configmap/kubectl/ui.properties
color.good=purple
color.bad=yellow
allow.textmode=true
how.nice.to.look=fairlyNice
</pre>
</div>

<p>
使用下面的命令可以创建一个包含目录中所有文件的ConfigMap：
</p>

<div class="org-src-container">
<pre class="src src-sh">$ kubectl create configmap game-config --from-file=docs/user-guide/configmap/kubectl
</pre>
</div>

<p>
<span class="underline">&#x2013;from-file</span> 指定在目录下的所有文件都会被用在ConfigMap里面创建一个键值对，键的名字就是文件名，值就是文件的内容。来看一下这个命令创建的ConfigMap：
</p>

<div class="org-src-container">
<pre class="src src-sh">$ kubectl describe configmaps game-config
Name:           game-config
Namespace:      default
Labels:         &lt;none&gt;
Annotations:    &lt;none&gt;

Data
====
game.properties:        158 bytes
ui.properties:          83 bytes
</pre>
</div>

<p>
可以看到那两个key是从kubectl指定的目录中的文件名
</p>

<pre class="example" id="org1073bbc">
这些key的内容可能会很大，所以在kubectl describe的输出中，只能够看到键的名字和他们的大小
</pre>

<p>
如果想要看到键的值的话，可以使用kubectl get：
</p>

<pre class="example" id="org1f64302">
apiVersion: v1
data:
  game.properties: |
    enemies=aliens
    lives=3
    enemies.cheat=true
    enemies.cheat.level=noGoodRotten
    secret.code.passphrase=UUDDLRLRBABAS
    secret.code.allowed=true
    secret.code.lives=30
  ui.properties: |
    color.good=purple
    color.bad=yellow
    allow.textmode=true
    how.nice.to.look=fairlyNice
kind: ConfigMap
metadata:
  creationTimestamp: 2016-02-18T18:34:05Z
  name: game-config
  namespace: default
  resourceVersion: "407"
  selfLink: /api/v1/namespaces/default/configmaps/game-config
  uid: 30944725-d66e-11e5-8cd0-68f728db1985
</pre>
</div>
</div>

<div id="outline-container-org4f98d81" class="outline-3">
<h3 id="org4f98d81">文件</h3>
<div class="outline-text-3" id="text-org4f98d81">
<pre class="example" id="orgd670d1e">
刚才使用目录创建的时候--from-file指定的是一个目录
</pre>
<p>
只要指定为一个文件就可以从单个文件中创建ConfigMap：
</p>

<div class="org-src-container">
<pre class="src src-sh">$ kubectl create configmap game-config-2 --from-file=docs/user-guide/configmap/kubectl/game.properties 

$ kubectl get configmaps game-config-2 -o yaml
</pre>
</div>

<pre class="example" id="orgb907ef3">
apiVersion: v1
data:
  game-special-key: |
    enemies=aliens
    lives=3
    enemies.cheat=true
    enemies.cheat.level=noGoodRotten
    secret.code.passphrase=UUDDLRLRBABAS
    secret.code.allowed=true
    secret.code.lives=30
kind: ConfigMap
metadata:
  creationTimestamp: 2016-02-18T18:54:22Z
  name: game-config-3
  namespace: default
  resourceVersion: "530"
  selfLink: /api/v1/namespaces/default/configmaps/game-config-3
  uid: 05f8da22-d671-11e5-8cd0-68f728db1985
</pre>

<p>
<span class="underline">&#x2013;from-file</span> 这个参数可以使用多次
</p>

<pre class="example" id="org3cd93e8">
可以使用两次分别指定上个实例中的那两个配置文件，效果就跟指定整个目录是一样的
</pre>
</div>
</div>

<div id="outline-container-org2e5fb83" class="outline-3">
<h3 id="org2e5fb83">字面值</h3>
<div class="outline-text-3" id="text-org2e5fb83">
<p>
使用文字值创建，利用 <span class="underline">&#x2013;from-literal</span> 参数传递配置信息，该参数可以使用多次，格式如下；
</p>

<div class="org-src-container">
<pre class="src src-sh">$ kubectl create configmap special-config --from-literal=special.how=very --from-literal=special.type=charm

$ kubectl get configmaps special-config -o yaml
</pre>
</div>

<pre class="example" id="orge1ceb2f">
apiVersion: v1
data:
  special.how: very
  special.type: charm
kind: ConfigMap
metadata:
  creationTimestamp: 2016-02-18T19:14:38Z
  name: special-config
  namespace: default
  resourceVersion: "651"
  selfLink: /api/v1/namespaces/default/configmaps/special-config
  uid: dadce046-d673-11e5-8cd0-68f728db1985
</pre>
</div>
</div>
</div>

<div id="outline-container-orga67013c" class="outline-2">
<h2 id="orga67013c">使用</h2>
<div class="outline-text-2" id="text-orga67013c">
</div>
<div id="outline-container-org6839e5f" class="outline-3">
<h3 id="org6839e5f">替代环境变量</h3>
<div class="outline-text-3" id="text-org6839e5f">
<p>
ConfigMap可以被用来填入环境变量：
</p>
<pre class="example" id="org877f714">
apiVersion: v1
kind: ConfigMap
metadata:
  name: special-config
  namespace: default
data:
  special.how: very
  special.type: charm
</pre>

<pre class="example" id="org0426f03">
apiVersion: v1
kind: ConfigMap
metadata:
  name: env-config
  namespace: default
data:
  log_level: INFO
</pre>

<p>
在Pod中这样使用ConfigMap：
</p>

<pre class="example" id="org132f676">

apiVersion: v1
kind: Pod
metadata:
  name: dapi-test-pod
spec:
  containers:
    - name: test-container
      image: gcr.io/google_containers/busybox
      command: [ "/bin/sh", "-c", "env" ]
      env:
	- name: SPECIAL_LEVEL_KEY
	  valueFrom:
	    configMapKeyRef:
	      name: special-config
	      key: special.how
	- name: SPECIAL_TYPE_KEY
	  valueFrom:
	    configMapKeyRef:
	      name: special-config
	      key: special.type
      envFrom:
	- configMapRef:
	    name: env-config
  restartPolicy: Never
</pre>

<p>
这个Pod运行后会输出如下几行：
</p>

<div class="org-src-container">
<pre class="src src-sh"><span style="color: #eedd82;">SPECIAL_LEVEL_KEY</span>=very
<span style="color: #eedd82;">SPECIAL_TYPE_KEY</span>=charm
<span style="color: #eedd82;">log_level</span>=INFO
</pre>
</div>
</div>
</div>

<div id="outline-container-orga167bf1" class="outline-3">
<h3 id="orga167bf1">设置命令行参数</h3>
<div class="outline-text-3" id="text-orga167bf1">
<p>
ConfigMap也可以被使用来设置容器中的命令或者参数值。它使用的是Kubernetes的 <span class="underline">$(VAR_NAME)</span> 替换语法：
</p>

<pre class="example" id="org02f992e">
apiVersion: v1
kind: ConfigMap
metadata:
  name: special-config
  namespace: default
data:
  special.how: very
  special.type: charm
</pre>

<p>
为了将ConfigMap中的值注入到命令行的参数里面，还要像前面那个例子一样使用环境变量替换语法$(VAR_NAME)
</p>

<pre class="example" id="org357d4c8">
apiVersion: v1
kind: Pod
metadata:
  name: dapi-test-pod
spec:
  containers:
    - name: test-container
      image: gcr.io/google_containers/busybox
      command: [ "/bin/sh", "-c", "echo $(SPECIAL_LEVEL_KEY) $(SPECIAL_TYPE_KEY)" ]
      env:
	- name: SPECIAL_LEVEL_KEY
	  valueFrom:
	    configMapKeyRef:
	      name: special-config
	      key: special.how
	- name: SPECIAL_TYPE_KEY
	  valueFrom:
	    configMapKeyRef:
	      name: special-config
	      key: special.type
  restartPolicy: Never
</pre>
<p>
运行这个Pod后会输出：
</p>

<div class="org-src-container">
<pre class="src src-sh">very charm
</pre>
</div>

<pre class="example" id="orgecadf08">
其实这个东西就是给Docker容器设置环境变量，通过：

1. docker run的时候指定-e参数修改镜像里的环境变量
2. docker的CMD命令再利用该$(VAR_NAME)通过sed来修改配置文件或者作为命令行启动参数
</pre>
</div>
</div>

<div id="outline-container-org764cd8e" class="outline-3">
<h3 id="org764cd8e">数据卷插件使用ConfigMap</h3>
<div class="outline-text-3" id="text-org764cd8e">
<p>
在数据卷里面使用这个ConfigMap，有不同的选项。最基本的就是将 <span class="underline">文件</span> <b>填入</b> <span class="underline">数据卷</span> ，在这个文件中，键就是文件名，键值就是文件内容：
</p>

<pre class="example" id="org356afbc">
apiVersion: v1
kind: Pod
metadata:
  name: dapi-test-pod
spec:
  containers:
    - name: test-container
      image: gcr.io/google_containers/busybox
      command: [ "/bin/sh", "-c", "cat /etc/config/special.how" ]
      volumeMounts:
      - name: config-volume
	mountPath: /etc/config
  volumes:
    - name: config-volume
      configMap:
	name: special-config
  restartPolicy: Never
</pre>

<p>
运行这个Pod的输出：
</p>

<div class="org-src-container">
<pre class="src src-sh">very
</pre>
</div>

<p>
也可以在ConfigMap值被映射的数据卷里控制路径：
</p>

<pre class="example" id="org07c7ee2">
apiVersion: v1
kind: Pod
metadata:
  name: dapi-test-pod
spec:
  containers:
    - name: test-container
      image: gcr.io/google_containers/busybox
      command: [ "/bin/sh","-c","cat /etc/config/path/to/special-key" ]
      volumeMounts:
      - name: config-volume
	mountPath: /etc/config
  volumes:
    - name: config-volume
      configMap:
	name: special-config
	items:
	- key: special.how
	  path: path/to/special-key
  restartPolicy: Never
</pre>

<p>
输出结果仍然是：
</p>
<pre class="example">
very
</pre>
</div>
</div>
</div>

<div id="outline-container-org2341fe7" class="outline-2">
<h2 id="org2341fe7">热更新</h2>
<div class="outline-text-2" id="text-org2341fe7">
<pre class="example" id="org284cff8">
ConfigMap是用来存储配置文件的kubernetes资源对象，所有的配置内容都存储在etcd中
</pre>

<p>
接下来主要探究 ConfigMap 的创建和更新流程，以及对 ConfigMap 更新后容器内挂载的内容是否同步更新的测试
</p>
</div>


<div id="outline-container-orge60447e" class="outline-3">
<h3 id="orge60447e">测试示例</h3>
<div class="outline-text-3" id="text-orge60447e">
<p>
假设在 default namespace 下有一个名为 <span class="underline">nginx-config</span> 的 ConfigMap，可以使用 kubectl命令来获取：
</p>

<div class="org-src-container">
<pre class="src src-sh">$ kubectl get configmap nginx-config
NAME           DATA      AGE
nginx-config   1         99d
</pre>
</div>

<p>
获取该ConfigMap的内容：
</p>

<div class="org-src-container">
<pre class="src src-sh">$ kubectl get configmap nginx-config -o yaml
</pre>
</div>

<pre class="example" id="org6eaafeb">
apiVersion: v1
data:
  nginx.conf: |-
    worker_processes 1;

    events { worker_connections 1024; }

    http {
	sendfile on;

	server {
	    listen 80;

	    # a test endpoint that returns http 200s
	    location / {
		proxy_pass http://httpstat.us/200;
		proxy_set_header  X-Real-IP  $remote_addr;
	    }
	}

	server {

	    listen 80;
	    server_name api.hello.world;

	    location / {
		proxy_pass http://l5d.default.svc.cluster.local;
		proxy_set_header Host $host;
		proxy_set_header Connection "";
		proxy_http_version 1.1;

		more_clear_input_headers 'l5d-ctx-*' 'l5d-dtab' 'l5d-sample';
	    }
	}

	server {

	    listen 80;
	    server_name www.hello.world;

	    location / {


		# allow 'employees' to perform dtab overrides
		if ($cookie_special_employee_cookie != "letmein") {
		  more_clear_input_headers 'l5d-ctx-*' 'l5d-dtab' 'l5d-sample';
		}

		# add a dtab override to get people to our beta, world-v2
		set $xheader "";

		if ($cookie_special_employee_cookie ~* "dogfood") {
		  set $xheader "/host/world =&gt; /srv/world-v2;";
		}

		proxy_set_header 'l5d-dtab' $xheader;


		proxy_pass http://l5d.default.svc.cluster.local;
		proxy_set_header Host $host;
		proxy_set_header Connection "";
		proxy_http_version 1.1;
	    }
	}
    }
kind: ConfigMap
metadata:
  creationTimestamp: 2017-08-01T06:53:17Z
  name: nginx-config
  namespace: default
  resourceVersion: "14925806"
  selfLink: /api/v1/namespaces/default/configmaps/nginx-config
  uid: 18d70527-7686-11e7-bfbd-8af1e3a7c5bd
</pre>

<p>
ConfigMap中的内容是存储到etcd中的，然后查询etcd：
</p>

<div class="org-src-container">
<pre class="src src-sh">$ <span style="color: #eedd82;">ETCDCTL_API</span>=3 etcdctl get /registry/configmaps/default/nginx-config -w json|python -m json.tool
</pre>
</div>

<pre class="example" id="org55597c1">
注意：使用 v3 版本的 etcdctl API
</pre>

<p>
下面是输出结果：
</p>

<div class="org-src-container">
<pre class="src src-js">{
    <span style="color: #ffa07a;">"count"</span>: 1,
    <span style="color: #ffa07a;">"header"</span>: {
        <span style="color: #ffa07a;">"cluster_id"</span>: 12091028579527406772,
        <span style="color: #ffa07a;">"member_id"</span>: 16557816780141026208,
        <span style="color: #ffa07a;">"raft_term"</span>: 36,
        <span style="color: #ffa07a;">"revision"</span>: 29258723
    },
    <span style="color: #ffa07a;">"kvs"</span>: [
        {
            <span style="color: #ffa07a;">"create_revision"</span>: 14925806,
            <span style="color: #ffa07a;">"key"</span>: <span style="color: #ffa07a;">"L3JlZ2lzdHJ5L2NvbmZpZ21hcHMvZGVmYXVsdC9uZ2lueC1jb25maWc="</span>,
            <span style="color: #ffa07a;">"mod_revision"</span>: 14925806,
            <span style="color: #ffa07a;">"value"</span>: <span style="color: #ffa07a;">"azhzAAoPCgJ2MRIJQ29uZmlnTWFwEqQMClQKDG5naW54LWNvbmZpZxIAGgdkZWZhdWx0IgAqJDE4ZDcwNTI3LTc2ODYtMTFlNy1iZmJkLThhZjFlM2E3YzViZDIAOABCCwjdyoDMBRC5ss54egASywsKCm5naW54LmNvbmYSvAt3b3JrZXJfcHJvY2Vzc2VzIDE7CgpldmVudHMgeyB3b3JrZXJfY29ubmVjdGlvbnMgMTAyNDsgfQoKaHR0cCB7CiAgICBzZW5kZmlsZSBvbjsKCiAgICBzZXJ2ZXIgewogICAgICAgIGxpc3RlbiA4MDsKCiAgICAgICAgIyBhIHRlc3QgZW5kcG9pbnQgdGhhdCByZXR1cm5zIGh0dHAgMjAwcwogICAgICAgIGxvY2F0aW9uIC8gewogICAgICAgICAgICBwcm94eV9wYXNzIGh0dHA6Ly9odHRwc3RhdC51cy8yMDA7CiAgICAgICAgICAgIHByb3h5X3NldF9oZWFkZXIgIFgtUmVhbC1JUCAgJHJlbW90ZV9hZGRyOwogICAgICAgIH0KICAgIH0KCiAgICBzZXJ2ZXIgewoKICAgICAgICBsaXN0ZW4gODA7CiAgICAgICAgc2VydmVyX25hbWUgYXBpLmhlbGxvLndvcmxkOwoKICAgICAgICBsb2NhdGlvbiAvIHsKICAgICAgICAgICAgcHJveHlfcGFzcyBodHRwOi8vbDVkLmRlZmF1bHQuc3ZjLmNsdXN0ZXIubG9jYWw7CiAgICAgICAgICAgIHByb3h5X3NldF9oZWFkZXIgSG9zdCAkaG9zdDsKICAgICAgICAgICAgcHJveHlfc2V0X2hlYWRlciBDb25uZWN0aW9uICIiOwogICAgICAgICAgICBwcm94eV9odHRwX3ZlcnNpb24gMS4xOwoKICAgICAgICAgICAgbW9yZV9jbGVhcl9pbnB1dF9oZWFkZXJzICdsNWQtY3R4LSonICdsNWQtZHRhYicgJ2w1ZC1zYW1wbGUnOwogICAgICAgIH0KICAgIH0KCiAgICBzZXJ2ZXIgewoKICAgICAgICBsaXN0ZW4gODA7CiAgICAgICAgc2VydmVyX25hbWUgd3d3LmhlbGxvLndvcmxkOwoKICAgICAgICBsb2NhdGlvbiAvIHsKCgogICAgICAgICAgICAjIGFsbG93ICdlbXBsb3llZXMnIHRvIHBlcmZvcm0gZHRhYiBvdmVycmlkZXMKICAgICAgICAgICAgaWYgKCRjb29raWVfc3BlY2lhbF9lbXBsb3llZV9jb29raWUgIT0gImxldG1laW4iKSB7CiAgICAgICAgICAgICAgbW9yZV9jbGVhcl9pbnB1dF9oZWFkZXJzICdsNWQtY3R4LSonICdsNWQtZHRhYicgJ2w1ZC1zYW1wbGUnOwogICAgICAgICAgICB9CgogICAgICAgICAgICAjIGFkZCBhIGR0YWIgb3ZlcnJpZGUgdG8gZ2V0IHBlb3BsZSB0byBvdXIgYmV0YSwgd29ybGQtdjIKICAgICAgICAgICAgc2V0ICR4aGVhZGVyICIiOwoKICAgICAgICAgICAgaWYgKCRjb29raWVfc3BlY2lhbF9lbXBsb3llZV9jb29raWUgfiogImRvZ2Zvb2QiKSB7CiAgICAgICAgICAgICAgc2V0ICR4aGVhZGVyICIvaG9zdC93b3JsZCA9PiAvc3J2L3dvcmxkLXYyOyI7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHByb3h5X3NldF9oZWFkZXIgJ2w1ZC1kdGFiJyAkeGhlYWRlcjsKCgogICAgICAgICAgICBwcm94eV9wYXNzIGh0dHA6Ly9sNWQuZGVmYXVsdC5zdmMuY2x1c3Rlci5sb2NhbDsKICAgICAgICAgICAgcHJveHlfc2V0X2hlYWRlciBIb3N0ICRob3N0OwogICAgICAgICAgICBwcm94eV9zZXRfaGVhZGVyIENvbm5lY3Rpb24gIiI7CiAgICAgICAgICAgIHByb3h5X2h0dHBfdmVyc2lvbiAxLjE7CiAgICAgICAgfQogICAgfQp9GgAiAA=="</span>,
            <span style="color: #ffa07a;">"version"</span>: 1
        }
    ]
}
</pre>
</div>

<p>
其中的value就是 nginx.conf 配置文件的内容 
</p>

<pre class="example" id="org95d87ac">
可以使用base64解码查看具体值
</pre>
</div>
</div>

<div id="outline-container-org2d0fb10" class="outline-3">
<h3 id="org2d0fb10">代码</h3>
<div class="outline-text-3" id="text-org2d0fb10">
<p>
<span class="underline">ConfigMap 结构体</span> 的定义：
</p>

<div class="org-src-container">
<pre class="src src-go"><span style="color: #ff4500;">// </span><span style="color: #ff4500;">ConfigMap holds configuration data for pods to consume.</span>
<span style="color: #00ffff;">type</span> <span style="color: #98fb98;">ConfigMap</span> <span style="color: #00ffff;">struct</span> {
        metav1.TypeMeta <span style="color: #ffa07a;">`json:",inline"`</span>
        <span style="color: #ff4500;">// </span><span style="color: #ff4500;">Standard object's metadata.</span>
        <span style="color: #ff4500;">// </span><span style="color: #ff4500;">More info: http://releases.k8s.io/HEAD/docs/devel/api-conventions.md#metadata</span>
        <span style="color: #ff4500;">// </span><span style="color: #ff4500;">+optional</span>
        metav1.ObjectMeta <span style="color: #ffa07a;">`json:"metadata,omitempty" protobuf:"bytes,1,opt,name=metadata"`</span>

        <span style="color: #ff4500;">// </span><span style="color: #ff4500;">Data contains the configuration data.</span>
        <span style="color: #ff4500;">// </span><span style="color: #ff4500;">Each key must be a valid DNS_SUBDOMAIN with an optional leading dot.</span>
        <span style="color: #ff4500;">// </span><span style="color: #ff4500;">+optional</span>
        Data <span style="color: #00ffff;">map</span>[<span style="color: #98fb98;">string</span>]<span style="color: #98fb98;">string</span> <span style="color: #ffa07a;">`json:"data,omitempty" protobuf:"bytes,2,rep,name=data"`</span>
}
</pre>
</div>

<p>
在 <span class="underline">staging/src/k8s.io/client-go/kubernetes/typed/core/v1/configmap.go</span> 中ConfigMap 的接口定义：
</p>

<div class="org-src-container">
<pre class="src src-go"><span style="color: #ff4500;">// </span><span style="color: #ff4500;">ConfigMapInterface has methods to work with ConfigMap resources.</span>
<span style="color: #00ffff;">type</span> <span style="color: #98fb98;">ConfigMapInterface</span> <span style="color: #00ffff;">interface</span> {
        <span style="color: #87cefa;">Create</span>(*<span style="color: #98fb98;">v1.ConfigMap</span>) (*<span style="color: #98fb98;">v1.ConfigMap</span>, <span style="color: #98fb98;">error</span>)
        <span style="color: #87cefa;">Update</span>(*<span style="color: #98fb98;">v1.ConfigMap</span>) (*<span style="color: #98fb98;">v1.ConfigMap</span>, <span style="color: #98fb98;">error</span>)
        <span style="color: #87cefa;">Delete</span>(<span style="color: #eedd82;">name</span> <span style="color: #98fb98;">string</span>, <span style="color: #eedd82;">options</span> *<span style="color: #98fb98;">meta_v1.DeleteOptions</span>) <span style="color: #98fb98;">error</span>
        <span style="color: #87cefa;">DeleteCollection</span>(<span style="color: #eedd82;">options</span> *<span style="color: #98fb98;">meta_v1.DeleteOptions</span>, <span style="color: #eedd82;">listOptions</span> <span style="color: #98fb98;">meta_v1.ListOptions</span>) <span style="color: #98fb98;">error</span>
        <span style="color: #87cefa;">Get</span>(<span style="color: #eedd82;">name</span> <span style="color: #98fb98;">string</span>, <span style="color: #eedd82;">options</span> <span style="color: #98fb98;">meta_v1.GetOptions</span>) (*<span style="color: #98fb98;">v1.ConfigMap</span>, <span style="color: #98fb98;">error</span>)
        <span style="color: #87cefa;">List</span>(<span style="color: #eedd82;">opts</span> <span style="color: #98fb98;">meta_v1.ListOptions</span>) (*<span style="color: #98fb98;">v1.ConfigMapList</span>, <span style="color: #98fb98;">error</span>)
        <span style="color: #87cefa;">Watch</span>(<span style="color: #eedd82;">opts</span> <span style="color: #98fb98;">meta_v1.ListOptions</span>) (<span style="color: #98fb98;">watch.Interface</span>, <span style="color: #98fb98;">error</span>)
        <span style="color: #87cefa;">Patch</span>(<span style="color: #eedd82;">name</span> <span style="color: #98fb98;">string</span>, <span style="color: #eedd82;">pt</span> <span style="color: #98fb98;">types.PatchType</span>, <span style="color: #eedd82;">data</span> []<span style="color: #98fb98;">byte</span>, <span style="color: #eedd82;">subresources</span> ...<span style="color: #98fb98;">string</span>) (<span style="color: #eedd82;">result</span> *<span style="color: #98fb98;">v1.ConfigMap</span>, <span style="color: #eedd82;">err</span> <span style="color: #98fb98;">error</span>)
        ConfigMapExpansion
}
</pre>
</div>

<p>
在 staging/src/k8s.io/client-go/kubernetes/typed/core/v1/configmap.go 中 <b>创建</b> ConfigMap 的方法如下:
</p>

<div class="org-src-container">
<pre class="src src-go"><span style="color: #ff4500;">// </span><span style="color: #ff4500;">Create takes the representation of a configMap and creates it.  Returns the server's representation of the configMap, and an error, if there is any.</span>
<span style="color: #00ffff;">func</span> (<span style="color: #eedd82;">c</span> *<span style="color: #98fb98;">configMaps</span>) <span style="color: #87cefa;">Create</span>(<span style="color: #eedd82;">configMap</span> *<span style="color: #98fb98;">v1.ConfigMap</span>) (<span style="color: #eedd82;">result</span> *<span style="color: #98fb98;">v1.ConfigMap</span>, <span style="color: #eedd82;">err</span> <span style="color: #98fb98;">error</span>) {
        result = &amp;<span style="color: #98fb98;">v1.ConfigMap</span>{}
        err = c.client.<span style="color: #87cefa;">Post</span>().
                <span style="color: #87cefa;">Namespace</span>(c.ns).
                <span style="color: #87cefa;">Resource</span>(<span style="color: #ffa07a;">"configmaps"</span>).
                <span style="color: #87cefa;">Body</span>(configMap).
                <span style="color: #87cefa;">Do</span>().
                <span style="color: #87cefa;">Into</span>(result)
        <span style="color: #00ffff;">return</span>
}
</pre>
</div>

<p>
通过 RESTful 请求在 etcd 中存储 ConfigMap 的配置，该方法中设置了资源对象的 <span class="underline">namespace</span> 和 HTTP 请求中的 <span class="underline">body</span> ，执行后将 <span class="underline">请求结果</span> <b>保存</b> 到 <span class="underline">result</span> 中返回给调用者
</p>
<ul class="org-ul">
<li><p>
Body 的结构：
</p>
<div class="org-src-container">
<pre class="src src-go"><span style="color: #ff4500;">// </span><span style="color: #ff4500;">Body makes the request use obj as the body. Optional.</span>
<span style="color: #ff4500;">// </span><span style="color: #ff4500;">If obj is a string, try to read a file of that name.</span>
<span style="color: #ff4500;">// </span><span style="color: #ff4500;">If obj is a []byte, send it directly.</span>
<span style="color: #ff4500;">// </span><span style="color: #ff4500;">If obj is an io.Reader, use it directly.</span>
<span style="color: #ff4500;">// </span><span style="color: #ff4500;">If obj is a runtime.Object, marshal it correctly, and set Content-Type header.</span>
<span style="color: #ff4500;">// </span><span style="color: #ff4500;">If obj is a runtime.Object and nil, do nothing.</span>
<span style="color: #ff4500;">// </span><span style="color: #ff4500;">Otherwise, set an error.</span>
</pre>
</div>
<pre class="example" id="org6efa3dc">
创建 ConfigMap RESTful 请求中的的 Body 中包含 ObjectMeta 和 namespace
</pre></li>
<li><p>
HTTP 请求中的结构体：
</p>
<div class="org-src-container">
<pre class="src src-go"><span style="color: #ff4500;">// </span><span style="color: #ff4500;">Request allows for building up a request to a server in a chained fashion.</span>
<span style="color: #ff4500;">// </span><span style="color: #ff4500;">Any errors are stored until the end of your call, so you only have to</span>
<span style="color: #ff4500;">// </span><span style="color: #ff4500;">check once.</span>
<span style="color: #00ffff;">type</span> <span style="color: #98fb98;">Request</span> <span style="color: #00ffff;">struct</span> {
        <span style="color: #ff4500;">// </span><span style="color: #ff4500;">required</span>
        client <span style="color: #98fb98;">HTTPClient</span>
        verb   <span style="color: #98fb98;">string</span>

        baseURL     *<span style="color: #98fb98;">url.URL</span>
        content     <span style="color: #98fb98;">ContentConfig</span>
        serializers <span style="color: #98fb98;">Serializers</span>

        <span style="color: #ff4500;">// </span><span style="color: #ff4500;">generic components accessible via method setters</span>
        pathPrefix <span style="color: #98fb98;">string</span>
        subpath    <span style="color: #98fb98;">string</span>
        params     <span style="color: #98fb98;">url.Values</span>
        headers    <span style="color: #98fb98;">http.Header</span>

        <span style="color: #ff4500;">// </span><span style="color: #ff4500;">structural elements of the request that are part of the Kubernetes API conventions</span>
        namespace    <span style="color: #98fb98;">string</span>
        namespaceSet <span style="color: #98fb98;">bool</span>
        resource     <span style="color: #98fb98;">string</span>
        resourceName <span style="color: #98fb98;">string</span>
        subresource  <span style="color: #98fb98;">string</span>
        timeout      <span style="color: #98fb98;">time.Duration</span>

        <span style="color: #ff4500;">// </span><span style="color: #ff4500;">output</span>
        err  <span style="color: #98fb98;">error</span>
        body <span style="color: #98fb98;">io.Reader</span>

        <span style="color: #ff4500;">// </span><span style="color: #ff4500;">This is only used for per-request timeouts, deadlines, and cancellations.</span>
        ctx <span style="color: #98fb98;">context.Context</span>

        backoffMgr <span style="color: #98fb98;">BackoffManager</span>
        throttle   <span style="color: #98fb98;">flowcontrol.RateLimiter</span>
}
</pre>
</div></li>
</ul>
</div>
</div>

<div id="outline-container-org1ca8e81" class="outline-3">
<h3 id="org1ca8e81">测试</h3>
<div class="outline-text-3" id="text-org1ca8e81">
<p>
分别测试使用 ConfigMap 挂载 <span class="underline">Env</span> 和 <span class="underline">Volume</span> 的情况
</p>
</div>

<div id="outline-container-org5d67d4c" class="outline-4">
<h4 id="org5d67d4c">更新使用ConfigMap挂载的Env</h4>
<div class="outline-text-4" id="text-org5d67d4c">
<p>
使用下面的配置创建 nginx 容器测试更新 ConfigMap 后容器内的环境变量是否也跟着更新：
</p>

<pre class="example" id="org7e042d8">
apiVersion: extensions/v1beta1
kind: Deployment
metadata:
  name: my-nginx
spec:
  replicas: 1
  template:
    metadata:
      labels:
	run: my-nginx
    spec:
      containers:
      - name: my-nginx
	image: harbor-001.jimmysong.io/library/nginx:1.9
	ports:
	- containerPort: 80
	envFrom:
	- configMapRef:
	    name: env-config
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: env-config
  namespace: default
data:
  log_level: INFO
</pre>

<p>
获取环境变量的值：
</p>

<div class="org-src-container">
<pre class="src src-sh">$ kubectl exec <span style="color: #fa8072;">`kubectl get pods -l run=my-nginx  -o=name|cut -d "/" -f2`</span> env|grep log_level

<span style="color: #eedd82;">log_level</span>=INFO
</pre>
</div>

<p>
修改 ConfigMap：
</p>

<div class="org-src-container">
<pre class="src src-sh">$ kubectl edit configmap env-config

<span style="color: #ff4500;"># </span><span style="color: #ff4500;">&#20462;&#25913; log_level &#30340;&#20540;&#20026; DEBUG</span>
</pre>
</div>

<p>
再次查看环境变量的值：
</p>

<div class="org-src-container">
<pre class="src src-sh">$ kubectl exec <span style="color: #fa8072;">`kubectl get pods -l run=my-nginx  -o=name|cut -d "/" -f2`</span> env|grep log_level

<span style="color: #eedd82;">log_level</span>=INFO
</pre>
</div>

<p>
实践证明修改 ConfigMap 无法更新容器中已注入的环境变量信息
</p>
</div>
</div>

<div id="outline-container-org205b601" class="outline-4">
<h4 id="org205b601">更新使用ConfigMap挂载的Volume</h4>
<div class="outline-text-4" id="text-org205b601">
<p>
使用下面的配置创建 nginx 容器测试更新 ConfigMap 后容器内挂载的文件是否也跟着更新：
</p>

<pre class="example" id="org1e51829">
apiVersion: extensions/v1beta1
kind: Deployment
metadata:
  name: my-nginx
spec:
  replicas: 1
  template:
    metadata:
      labels:
	run: my-nginx
    spec:
      containers:
      - name: my-nginx
	image: harbor-001.jimmysong.io/library/nginx:1.9
	ports:
	- containerPort: 80
	volumeMounts:
	- name: config-volume
	  mountPath: /etc/config
      volumes:
	- name: config-volume
	  configMap:
	    name: special-config
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: special-config
  namespace: default
data:
  log_level: INFO
</pre>

<p>
查看配置文件的值
</p>
<pre class="example" id="orgb9eef39">
$ kubectl exec `kubectl get pods -l run=my-nginx  -o=name|cut -d "/" -f2` cat /etc/config/log_level

INFO
</pre>

<p>
修改 ConfigMap
</p>

<div class="org-src-container">
<pre class="src src-sh">$ kubectl edit configmap special-config

<span style="color: #ff4500;"># </span><span style="color: #ff4500;">&#20462;&#25913; log_level &#30340;&#20540;&#20026; DEBUG</span>
</pre>
</div>

<p>
等待大概10秒钟时间，再次查看：
</p>

<div class="org-src-container">
<pre class="src src-sh">$ kubectl exec <span style="color: #fa8072;">`kubectl get pods -l run=my-nginx  -o=name|cut -d "/" -f2`</span> cat /etc/config/log_level

DENUG
</pre>
</div>

<p>
可以看到使用 ConfigMap 方式挂载的 Volume 的文件中的内容已经变成了 DEBUG 
</p>
</div>
</div>
</div>

<div id="outline-container-org1d87099" class="outline-3">
<h3 id="org1d87099">ConfigMap 更新后滚动更新 Pod</h3>
<div class="outline-text-3" id="text-org1d87099">
<p>
更新 ConfigMap 目前并不会触发相关 Pod 的滚动更新，可以通过 <b>修改</b> <span class="underline">pod annotations</span> 的方式 <b>强制触发</b> 滚动更新：
</p>

<div class="org-src-container">
<pre class="src src-sh">$ kubectl patch deployment my-nginx --patch <span style="color: #ffa07a;">'{"spec": {"template": {"metadata": {"annotations": {"version/config": "20180411" }}}}}'</span>
</pre>
</div>

<pre class="example" id="orgc5d063e">
这个例子里在 .spec.template.metadata.annotations 中添加 version/config，每次通过修改 version/config 来触发滚动更新
</pre>
</div>
</div>


<div id="outline-container-orgbfb1c44" class="outline-3">
<h3 id="orgbfb1c44">总结</h3>
<div class="outline-text-3" id="text-orgbfb1c44">
<p>
更新 ConfigMap 后：
</p>
<ul class="org-ul">
<li>使用该 ConfigMap 挂载的 Env 不会同步更新</li>
<li>使用该 ConfigMap 挂载的 Volume 中的数据需要一段时间（实测大概10秒）才能同步更新</li>
</ul>

<p>
ENV 是在容器启动的时候注入的，启动之后 kubernetes 就不会再改变环境变量的值，且同一个 namespace 中的 pod 的环境变量是不断累加的
</p>

<pre class="example" id="org1986b12">
参考 Kubernetes中的服务发现与docker容器间的环境变量传递源码探究 https://jimmysong.io/blog/exploring-kubernetes-env-with-docker
</pre>

<p>
为了更新容器中使用 ConfigMap 挂载的配置，需要通过滚动更新 pod 的方式来强制重新挂载 ConfigMap 
</p>

<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />
</colgroup>
<tbody>
<tr>
<td class="org-left"><a href="volume.html">Next: Volume</a></td>
<td class="org-left"><a href="secret.html">Previous: Secret</a></td>
<td class="org-left"><a href="storage.html">Home：存储</a></td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
</div>
<div id="postamble" class="status">

		  <br/>
		  <div class='ds-thread'></div>
		  <script>
		  var duoshuoQuery = {short_name:'klose911'};
		  (function() {
					  var dsThread = document.getElementsByClassName('ds-thread')[0];
					  dsThread.setAttribute('data-thread-key', document.title);
					  dsThread.setAttribute('data-title', document.title);
					  dsThread.setAttribute('data-url', window.location.href);
					  var ds = document.createElement('script');
					  ds.type = 'text/javascript';ds.async = true;
					  ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
					  ds.charset = 'UTF-8';
					  (document.getElementsByTagName('head')[0] 
						|| document.getElementsByTagName('body')[0]).appendChild(ds);
					  })();
		  </script>
		  <script>
		  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
			(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
			m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
			})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
		  ga('create', 'UA-90850421-1', 'auto');
		  ga('send', 'pageview');
		  </script>
</div>
</body>
</html>
